<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Network Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        background: linear-gradient(-45deg, #e3f2fd, #fce4ec, #e8f5e9, #fff3e0);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
      }

      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      header {
        background-color: #2c3e50;
        color: #fff;
        text-align: center;
        padding: 20px 0;
        font-size: 28px;
        font-weight: bold;
      }

      .container {
        width: 95%;
        margin: auto;
        padding: 20px;
      }

      h2.section-title {
        margin-top: 40px;
        margin-bottom: 20px;
        font-size: 24px;
        color: #2c3e50;
        border-bottom: 2px solid #007bff;
        display: inline-block;
        padding-bottom: 5px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.2s;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }

      .card h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }

      .card p {
        margin: 10px 0 0 0;
        font-size: 22px;
        font-weight: bold;
        color: #007bff;
      }

      .chart-container {
        background-color: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      table th,
      table td {
        padding: 12px 15px;
        text-align: left;
      }

      table th {
        background-color: #007bff;
        color: #fff;
      }

      table tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      table tr:hover {
        background-color: #e0f0ff;
      }

      .method-POST {
        color: #2ecc71;
        font-weight: bold;
      }
      .method-GET {
        color: #3498db;
        font-weight: bold;
      }
      .method-PUT {
        color: #f39c12;
        font-weight: bold;
      }
      .method-DELETE {
        color: #e74c3c;
        font-weight: bold;
      }
      .chart-card {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        max-width: 900px; /* ✅ prevent over-stretch */
        margin-left: auto;
        margin-right: auto;
      }

      canvas {
        max-height: 400px; /* ✅ stop huge pie/line chart */
      }
    </style>
  </head>

  <body>
    <header>Network Monitoring Dashboard</header>

    <div class="container">
      <!-- 🌐 Network Tracing Section -->
      <h2 class="section-title">Network Tracing</h2>
      <div class="cards">
        <div class="card">
          <h3>Total Requests</h3>
          <p id="totalRequests">0</p>
        </div>
        <div class="card">
          <h3>Active Users (Last 1h)</h3>
          <p id="activeUsers">0</p>
        </div>
        <div class="card">
          <h3>Average Response Time (ms)</h3>
          <p id="avgResponseTime">0</p>
        </div>
        <div class="card">
          <h3>Error Rate (%)</h3>
          <p id="errorRate">0</p>
        </div>
      </div>

      <!-- Recent Logs -->
      <div class="chart-container">
        <h3>Recent Logs</h3>
        <table id="logsTable">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>IP</th>
              <th>Method</th>
              <th>Path</th>
              <th>User-Agent</th>
              <th>Status</th>
              <th>Response Time (ms)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 📊 Network Traffic Section -->
      <h2 class="section-title">Network Traffic</h2>

      <!-- Endpoint Distribution -->
      <div class="chart-container">
        <h3>Requests per Endpoint</h3>
        <canvas id="endpointChart" height="100"></canvas>
      </div>

      <!-- Requests per Hour -->
      <div class="chart-container">
        <h3>Requests Per Hour (Last 24h)</h3>
        <canvas id="trafficChart"></canvas>
      </div>

      <!-- Status Code Distribution -->
      <div class="chart-container">
        <h3>Status Code Distribution</h3>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <script>
      async function fetchDashboardData() {
        try {
          const response = await fetch("/dashboard/data");
          const data = await response.json();

          // ✅ Summary Cards
          document.getElementById("totalRequests").textContent =
            data.total_requests;
          document.getElementById("activeUsers").textContent =
            data.active_users;
          document.getElementById("avgResponseTime").textContent =
            data.avg_response_time || 0;
          document.getElementById("errorRate").textContent =
            data.error_rate || 0;

          // ✅ Endpoint Distribution Chart
          const ctxEndpoint = document
            .getElementById("endpointChart")
            .getContext("2d");
          new Chart(ctxEndpoint, {
            type: "bar",
            data: {
              labels: data.endpoint_stats.map((e) => e._id),
              datasets: [
                {
                  label: "Requests per Endpoint",
                  data: data.endpoint_stats.map((e) => e.count),
                  backgroundColor: "rgba(41, 128, 185, 0.7)",
                },
              ],
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } },
          });

          // ✅ Requests per Hour Chart
          const ctxTraffic = document
            .getElementById("trafficChart")
            .getContext("2d");
          new Chart(ctxTraffic, {
            type: "line",
            data: {
              labels: data.traffic_labels,
              datasets: [
                {
                  label: "Requests per Hour",
                  data: data.traffic_counts,
                  borderColor: "rgba(46, 204, 113, 1)",
                  backgroundColor: "rgba(46, 204, 113, 0.2)",
                  fill: true,
                },
              ],
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } },
          });

          // ✅ Status Code Distribution Chart
          const ctxStatus = document
            .getElementById("statusChart")
            .getContext("2d");
          new Chart(ctxStatus, {
            type: "pie",
            data: {
              labels: data.status_labels,
              datasets: [
                {
                  label: "Status Codes",
                  data: data.status_counts,
                  backgroundColor: ["#3498db", "#e74c3c", "#f1c40f", "#2ecc71"],
                },
              ],
            },
            options: { responsive: true },
          });

          // ✅ Recent Logs
          const logsTable = document
            .getElementById("logsTable")
            .querySelector("tbody");
          logsTable.innerHTML = "";
          data.recent_logs.forEach((log) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${log.timestamp}</td>
              <td>${log.ip}</td>
              <td class="method-${log.method}">${log.method}</td>
              <td>${log.path}</td>
              <td>${log.user_agent}</td>
              <td>${log.status}</td>
              <td>${log.response_time}</td>
            `;
            logsTable.appendChild(row);
          });
        } catch (err) {
          console.error("Error fetching dashboard data:", err);
        }
      }

      window.onload = fetchDashboardData;
    </script>
  </body>
</html>
